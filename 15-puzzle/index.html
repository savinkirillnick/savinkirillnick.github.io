<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
    <title>Game</title>
    <style type="text/css">
body {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    align-items: center;
    justify-content: center;
    height: 100vh;
    font-family: sans-serif;
    background-color: black;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}
.fullscreen-game {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    font-family: Arial, sans-serif;
    background-color: black;
}
.game {
    position: relative;
    background-color: #222;
    width: 100vmin;
    height: 100vmin;
    color: white;
}
.congratulation-name {
    width: 100%;
    height: auto;
    font-size: clamp(1.5em, 8vw, 5em);
    text-align: center;
    padding: 2vw;
}
.congratulation-desc {
    width: auto;
    height: auto;
    font-size: clamp(1em, 5vw, 2.5em);
    margin: 1vw;
    padding: 2vw;
}
.congratulation-button {
    width: 50%;
    height: auto;
    font-size: clamp(1em, 5vw, 2.5em);
    padding: 3vw;
    background-color: blue;
    border-radius: 10px;
    margin: 1vw auto;
    text-align: center;
    color: white;
    font-weight: bold;
}

.puzzle-container {
    width: 100%;
    height: 100%;
    display: grid;
    grid-template-columns: repeat(4, 25%);
    grid-template-rows: repeat(4, 25%);
}
.tile {
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #006699;
    color: white;
    font-size: 10vw;
    cursor: pointer;
    border: 2vw solid #3498db;
    margin: .5vw;
}

.tile.empty {
    background-color: transparent;
    cursor: default;
    border: 2vw solid transparent;
}

@media (orientation: landscape) {
    .game {
        height: 100vh; /* В ландшафтном режиме квадрат по высоте экрана */
        width: 100vh;  /* В ландшафтном режиме квадрат по высоте экрана */
    }
    .fullscreen-game {
        flex-direction: column;
    }
    .tile {
        border: 2vh solid #3498db;
        margin: .5vh;
        font-size: 10vh;
    }
}

@media (orientation: portrait) {
    .game {
        height: 100vw; /* В портретном режиме квадрат по ширине экрана */
        width: 100vw;  /* В портретном режиме квадрат по ширине экрана */
    }
    .fullscreen-game {
        flex-direction: row;
    }
    .tile {
        border: 2vw solid #3498db;
        margin: .5vw;
        font-size: 10vw;
    }
}
    </style>
</head>
<body>
    <script type="text/javascript">

        class Game{
            constructor() {
                this.size = 4;  // Размерность поля 4x4
                this.runGame = this.runGame.bind(this);
                this.endGame = this.endGame.bind(this);
            }


            // Функция для создания и перемешивания плиток
            runGame() {
                
                //Создаем основной слой
                this.container = document.createElement('div');
                this.container.className = 'puzzle-container';

                document.getElementById("game").innerHTML = "";
                document.getElementById("game").appendChild(this.container);

                this.tiles = [];
                this.tiles = Array.from({ length: this.size * this.size }, (_, i) => i);
                this.shuffle(this.tiles);
                this.renderTiles();
            }

            // Функция рендеринга плиток
            renderTiles() {
                this.container.innerHTML = '';
                this.tiles.forEach(tile => {
                    const tileElement = document.createElement('div');
                    tileElement.className = 'tile' + (tile === 0 ? ' empty' : '');
                    tileElement.textContent = tile !== 0 ? tile : '';
                    tileElement.addEventListener('click', () => this.moveTile(tile));
                    this.container.appendChild(tileElement);
                });
            }

            // Функция перемешивания плиток
            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                const solvable = this.isPuzzleSolvable(array);
                if (!solvable) {
                    [array[array.indexOf(14)], array[array.indexOf(15)]] = [15, 14];
                }
            }

            // Функция перемещения плитки
            moveTile(tile) {
                const emptyIndex = this.tiles.indexOf(0);
                const tileIndex = this.tiles.indexOf(tile);

                const emptyRow = Math.floor(emptyIndex / this.size);
                const emptyCol = emptyIndex % this.size;
                const tileRow = Math.floor(tileIndex / this.size);
                const tileCol = tileIndex % this.size;

                const isAdjacent = (Math.abs(emptyRow - tileRow) + Math.abs(emptyCol - tileCol)) === 1;

                if (isAdjacent) {
                    this.tiles[emptyIndex] = tile;
                    this.tiles[tileIndex] = 0;
                    this.renderTiles();
                }

                const solved = this.isPuzzleSolved(this.tiles);
                if (solved) {
                    this.endGame();
                }
            }

            endGame() {
                setTimeout(() => {
                    document.getElementById("game").innerHTML = "";
                    
                    let divName = document.createElement('div');
                    divName.className = 'congratulation-name';
                    document.getElementById("game").appendChild(divName);
                    divName.innerHTML = "<br>⭐⭐⭐<br>Congratulation!";
                    
                    let divDesc = document.createElement('div');
                    divDesc.className = 'congratulation-desc';
                    document.getElementById("game").appendChild(divDesc);
                    divDesc.innerText = "You've been arranged tiles in a row!";

                    let divButton = document.createElement('div');
                    divButton.className = 'congratulation-button';
                    document.getElementById("game").appendChild(divButton);
                    divButton.innerText = "Play Again";
                    
                    divButton.addEventListener('click', this.runGame);
                }, 300);
            }

            isPuzzleSolvable(tiles) {

                let inv = 0;
                
                // Первая часть: подсчет инверсий
                for (let i = 0; i < 16; i++) {
                    if (tiles[i]) {
                        for (let j = 0; j < i; j++) {
                            if (tiles[j] > tiles[i]) {
                                inv++;
                            }
                        }
                    }
                }
                
                // Вторая часть: добавление позиции пустого элемента
                for (let i = 0; i < 16; i++) {
                    if (tiles[i] === 0) {
                        inv += 1 + Math.floor(i / 4);
                    }
                }
                
                // Вывод результата
                return (inv & 1) ? false : true;
            }

            // Альтернативная функция для проверки завершенного состояния
            isPuzzleSolved(tiles) {
                // Проверяем, что массив содержит правильную последовательность
                for (let i = 0; i < tiles.length - 1; i++) {
                    if (tiles[i] !== i + 1) {
                        return false;
                    }
                }
                // Последний элемент должен быть 0 (пустая клетка)
                return tiles[tiles.length - 1] === 0;
            }

        }

    </script>
    <div id="myGame" class="fullscreen-game">
        <div id="game" class="game">
            <div class="congratulation-name">
                <img src="https://i.imgur.com/5JNhY2u.png"><br>
                Fifteen puzzle
            </div>
            <div class="congratulation-desc">
                Arrange the tiles so that the numbers are in a row.
            </div>
            <div id="run_button" class="congratulation-button" onclick="runGame()">
                Play
            </div>
        </div>
    </div>
	<script type="text/javascript">

        const game = new Game();

        function runGame() {
            game.runGame();
        }

		function createMusicPlayer() {
		    let tracks = [
		        'https://savinkirillnick.github.io/music/track1.mp3',
		        'https://savinkirillnick.github.io/music/track2.mp3',
		        'https://savinkirillnick.github.io/music/track3.mp3',
		        'https://savinkirillnick.github.io/music/track4.mp3',
		        'https://savinkirillnick.github.io/music/track5.mp3',
		        'https://savinkirillnick.github.io/music/track6.mp3',
		        'https://savinkirillnick.github.io/music/track7.mp3',
		        'https://savinkirillnick.github.io/music/track8.mp3',
		        'https://savinkirillnick.github.io/music/track9.mp3',
		        'https://savinkirillnick.github.io/music/track10.mp3',
		        'https://savinkirillnick.github.io/music/track11.mp3',
		        'https://savinkirillnick.github.io/music/track12.mp3'
		    ];
		    
		    let currentTrackIndex = 0;
		    let audio = null;
		    let isPlaying = false;

			// Перемешаем треки
			tracks.sort(() => Math.random() - 0.5);
			
		    // Функция для воспроизведения текущего трека
		    function playCurrentTrack() {
		        // Останавливаем предыдущий трек, если он есть
		        if (audio) {
		            audio.pause();
		            audio = null;
		        }
		        
		        // Создаем новый аудио элемент
		        audio = new Audio(tracks[currentTrackIndex]);
		        audio.volume = 0.5;
		        
		        // Обработчик окончания трека
		        audio.addEventListener('ended', playNextTrack);
		        
		        // Пытаемся воспроизвести
		        audio.play().catch(error => {
		            console.error('Ошибка воспроизведения:', error);
		        });
		        
		        console.log('Сейчас играет:', tracks[currentTrackIndex]);
		    }
		    
		    // Функция для перехода к следующему треку
		    function playNextTrack() {
		        currentTrackIndex = (currentTrackIndex + 1) % tracks.length;
		        playCurrentTrack();
		    }
		    
		    // Функция для перехода к предыдущему треку
		    function playPreviousTrack() {
		        currentTrackIndex = (currentTrackIndex - 1 + tracks.length) % tracks.length;
		        playCurrentTrack();
		    }
		    
		    // Функция для запуска/паузы
		    function togglePlayPause() {
		        if (!audio) {
		            playCurrentTrack();
		            isPlaying = true;
		            return;
		        }
		        
		        if (audio.paused) {
		            audio.play();
		            isPlaying = true;
		        } else {
		            audio.pause();
		            isPlaying = false;
		        }
		    }
		    
		    // Функция для остановки музыки
		    function stopMusic() {
		        if (audio) {
		            audio.pause();
		            audio.currentTime = 0;
		            isPlaying = false;
		        }
		    }
		    
		    // Функция для изменения громкости
		    function setVolume(volume) {
		        if (audio) {
		            audio.volume = Math.max(0, Math.min(1, volume));
		        }
		    }
		    
		    // Возвращаем публичные методы
		    return {
		        start: function() {
		            if (!isPlaying) {
		                playCurrentTrack();
		                isPlaying = true;
		            }
		        },
		        togglePlayPause,
		        stop: stopMusic,
		        next: playNextTrack,
		        previous: playPreviousTrack,
		        setVolume,
		        getCurrentTrack: () => tracks[currentTrackIndex],
		        isPlaying: () => isPlaying
		    };
		}
		
		// Создаем экземпляр плеера
		const musicPlayer = createMusicPlayer();
		
		// Добавляем обработчик клика на всю страницу
		document.addEventListener('click', function(event) {
		    // Запускаем музыку только при первом клике
		    if (!musicPlayer.isPlaying()) {
		        musicPlayer.start();
		        
		        // Можно удалить обработчик после первого запуска
		        document.removeEventListener('click', arguments.callee);
		    }
		});
	</script>
</body>
</html>
